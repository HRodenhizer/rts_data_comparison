---
output:
  html_document: default
  pdf_document: default
---
# RTS Model V2 Performance Analysis

## TODO:

-   Figure out why there are multiple polygons for each imagery type and polygon.
-   Figure out which polygons the predictions were run for (plot predictions with polygon shapefiles to see which have predictions)
-   Update file download to check for local file before attempting to download


## Load Libraries

```{r, include = FALSE}
library(terra)
library(sf)
library(leaflet)
library(viridis)
library(googledrive)
library(jsonlite)
library(tidyverse)
```


## Prep Google Drive Authentication

```{r, include = FALSE}
drive_auth(email = 'hrodenhizer@woodwellclimate.org')
```


## Define Functions
### make_my_dir

```{r, include = FALSE}
make_my_dir <- function(output_dir) {

  if (!dir.exists(output_dir)){
    dir.create(output_dir, recursive = TRUE)
  }
  
}
```

### rast_from_googledrive

```{r, include = FALSE}
rast_from_googledrive <- function(name, id, drive_resource, directory) {
  current <- as_dribble(id)
  make_my_dir(directory)
  filepath = paste0(directory, name)
  
  if (!file.exists(filepath)) {
    print(filepath)
    dl <- drive_download(
      current,
      path = filepath)
  }
  
  raster <- rast(filepath)
  names(raster) <- c('prediction', 'validation')
  return(raster)
}
```

### json_from_googledrive

```{r, include = FALSE}
json_from_googledrive <- function(name, id, drive_resource, directory) {
  current <- as_dribble(id)
  make_my_dir(directory)
  filepath = paste0(directory, name)
  
  if (!file.exists(filepath)) {
    dl <- drive_download(
      current,
      path = filepath)
  }
  
  json <- fromJSON(txt = filepath)
  return(json)
}
```

### pred_as_poly

```{r, include = FALSE}
pred_as_poly <- function(prediction) {
  layer <- prediction[['prediction']]
  layer[layer >= 0.5] <- 1
  layer[layer < 0.5] <- NA
  poly <- st_as_sf(as.polygons(layer, values = FALSE)) %>%
      mutate(id = as.numeric(first(str_split(last(str_split(sources(prediction), 
                                                            '/')[[1]]), 
                                             '\\.')[[1]])))
  if (nrow(poly) == 0) {
    poly <- st_sf(id = as.numeric(first(str_split(last(str_split(sources(prediction), 
                                                            '/')[[1]]), 
                                             '\\.')[[1]])), 
                  geometry = st_sfc(st_polygon(), crs = crs(prediction)))
  }
  
  return(poly)
}
```

### val_as_poly

```{r, include = FALSE}
val_as_poly <- function(prediction, rts_poly) {
  layer <- prediction[['validation']]
  layer <- classify(layer, 
                    matrix(c(0, NA,
                             1, 1),
                           ncol = 2,
                           byrow = TRUE))
  current_id <- as.numeric(first(str_split(last(str_split(sources(prediction), 
                                                            '/')[[1]]), 
                                             '\\.')[[1]]))
  poly <- st_as_sf(as.polygons(layer, values = FALSE)) %>%
      mutate(id = current_id)
  if (nrow(poly) == 0) {
    poly <- st_sf(id = c(0), geometry = st_sfc(st_polygon(), crs = crs(prediction)))
  }
  
  return(poly)
}
```


## Load Data
### Polygons

```{r, echo = FALSE}
rts_outlines <- st_read('./data/rts_polygons/rts_polygons_for_Yili_May_2022.shp') %>%
  st_transform(crs = 26901)
```

### Maxar GeoTiffs
#### 20220925-105508

Parameters:
```{r, echo = FALSE}
# json metadata
metadata <- drive_ls('https://drive.google.com/drive/u/0/folders/1jUsWsjRPGSROwsT8ENHdsRhxen0p0FlN',
                             pattern = 'json$')
maxar_metadata_1 <- metadata %>%
  pmap(
    \(name, id, drive_resource, directory) json_from_googledrive(name, id, drive_resource, './data/maxar/predictions-m20220925-105508/')
    )
maxar_metadata_1 %>%
  toJSON() %>%
  minify()
```

```{r, include = FALSE}
maxar_pred_files <- drive_ls('https://drive.google.com/drive/u/0/folders/1jUsWsjRPGSROwsT8ENHdsRhxen0p0FlN',
                             pattern = 'tif$') %>%
  arrange(name)

maxar_preds_1 <- maxar_pred_files %>%
  pmap(
    \(name, id, drive_resource, directory) rast_from_googledrive(name, id, drive_resource, './data/maxar/predictions-m20220925-105508/')
    )
```

#### 20220925-105508-fixed

Parameters:
```{r, echo = FALSE}
# json metadata
metadata <- drive_ls('https://drive.google.com/drive/u/0/folders/1HGSyxXaIoyGNY0nI6Rbqg7evPMZa_iAm',
                             pattern = 'json$')
maxar_metadata_2 <- metadata %>%
  pmap(
    \(name, id, drive_resource, directory) json_from_googledrive(name, id, drive_resource, './data/maxar/predictions-m20220925-105508-fixed/')
    )
maxar_metadata_2 %>%
  toJSON() %>%
  minify()
```

```{r, include = FALSE}
maxar_pred_files <- drive_ls('https://drive.google.com/drive/u/0/folders/1HGSyxXaIoyGNY0nI6Rbqg7evPMZa_iAm',
                             pattern = 'tif$') %>%
  arrange(name)

maxar_preds_2 <- maxar_pred_files %>%
  pmap(
    \(name, id, drive_resource, directory) rast_from_googledrive(name, id, drive_resource, './data/maxar/predictions-m20220925-105508-fixed/')
    )
```

#### 20230317-181045

Parameters:
```{r, echo = FALSE}
# json metadata
metadata <- drive_ls('https://drive.google.com/drive/u/0/folders/1QicQlzWuaMh-muI28FPz-TlwTybAcB8T',
                             pattern = 'json$')
maxar_metadata_3 <- metadata %>%
  pmap(
    \(name, id, drive_resource, directory) json_from_googledrive(name, id, drive_resource, './data/maxar/predictions-m20230317-181045/')
    )
maxar_metadata_3 %>%
  toJSON() %>%
  minify()
```

```{r, include = FALSE}
maxar_pred_files <- drive_ls('https://drive.google.com/drive/u/0/folders/1QicQlzWuaMh-muI28FPz-TlwTybAcB8T',
                             pattern = 'tif$') %>%
  arrange(name)

maxar_preds_3 <- maxar_pred_files %>%
  pmap(
    \(name, id, drive_resource, directory) rast_from_googledrive(name, id, drive_resource, './data/maxar/predictions-m20230317-181045/')
    )
```

#### 20230426-213214

Parameters:
```{r, echo = FALSE}
# json metadata
metadata <- drive_ls('https://drive.google.com/drive/u/0/folders/10btUO5v9iLRRM0WM5hstBXgtfYEfSYGZ',
                             pattern = 'json$')
maxar_metadata_4 <- metadata %>%
  pmap(
    \(name, id, drive_resource, directory) json_from_googledrive(name, id, drive_resource, './data/maxar/predictions-m20230426-213214/')
    )
maxar_metadata_4 %>%
  toJSON() %>%
  minify()
```

```{r, include = FALSE}
maxar_pred_files <- drive_ls('https://drive.google.com/drive/u/0/folders/10btUO5v9iLRRM0WM5hstBXgtfYEfSYGZ',
                             pattern = 'tif$') %>%
  arrange(name)

maxar_preds_4 <- maxar_pred_files %>%
  pmap(
    \(name, id, drive_resource, directory) rast_from_googledrive(name, id, drive_resource, './data/maxar/predictions-m20230426-213214/')
    )
```

### Planet GeoTiffs
#### 20230411-102851

Parameters:
```{r, echo = FALSE}
# json metadata
metadata <- drive_ls('https://drive.google.com/drive/u/0/folders/15vdbvwgMh5RCnEzJekWY0_sVD4s4-fec',
                             pattern = 'json$')
planet_metadata_1 <- metadata %>%
  pmap(
    \(name, id, drive_resource, directory) json_from_googledrive(name, id, drive_resource, './data/planet/predictions-m20230411-102851/')
    )
planet_metadata_1 %>%
  toJSON() %>%
  minify()
```

```{r, include = FALSE}
planet_pred_files <- drive_ls('https://drive.google.com/drive/u/0/folders/15vdbvwgMh5RCnEzJekWY0_sVD4s4-fec',
                             pattern = 'tif$') %>%
  arrange(name)

planet_preds_1 <- planet_pred_files %>%
  pmap(
    \(name, id, drive_resource, directory) rast_from_googledrive(name, id, drive_resource, './data/planet/predictions-m20230411-102851/')
    )
```

#### 20230411-102851-fixed

Parameters:
```{r, echo = FALSE}
# json metadata
metadata <- drive_ls('https://drive.google.com/drive/u/0/folders/1Y28fskc7woYjZgh14xP-SBs-bKuG_PW0',
                             pattern = 'json$')
planet_metadata_2 <- metadata %>%
  pmap(
    \(name, id, drive_resource, directory) json_from_googledrive(name, id, drive_resource, './data/planet/predictions-m20230411-102851-fixed/')
    )
planet_metadata_2 %>%
  toJSON() %>%
  minify()
```

```{r, include = FALSE}
planet_pred_files <- drive_ls('https://drive.google.com/drive/u/0/folders/1Y28fskc7woYjZgh14xP-SBs-bKuG_PW0',
                             pattern = 'tif$') %>%
  arrange(name)

planet_preds_2 <- planet_pred_files %>%
  pmap(
    \(name, id, drive_resource, directory) rast_from_googledrive(name, id, drive_resource, './data/planet/predictions-m20230411-102851-fixed/')
    )
```

### Sentinel GeoTiffs
#### 20220923-131534

Parameters:
```{r, echo = FALSE}
# json metadata
metadata <- drive_ls('https://drive.google.com/drive/u/0/folders/1HygGBu1WZatYv1ejU80nOynGkYQU0Rsg',
                             pattern = 'json$')
sentinel_metadata_1 <- metadata %>%
  pmap(
    \(name, id, drive_resource, directory) json_from_googledrive(name, id, drive_resource, './data/sentinel2/predictions-m20220923-131534/')
    )
sentinel_metadata_1 %>%
  toJSON() %>%
  minify()
```

```{r, include = FALSE}
sentinel_pred_files <- drive_ls('https://drive.google.com/drive/u/0/folders/1HygGBu1WZatYv1ejU80nOynGkYQU0Rsg',
                             pattern = 'tif$') %>%
  arrange(name)

sentinel_preds_1 <- sentinel_pred_files %>%
  pmap(
    \(name, id, drive_resource, directory) rast_from_googledrive(name, id, drive_resource, './data/sentinel2/predictions-m20220923-131534/')
    )
```


## Convert Predictions to Vector

For now, use this to choose which version of the model output to use.
```{r}
maxar_preds <- maxar_preds_2
planet_preds <- planet_preds_2
sentinel_preds <- sentinel_preds_1
```

### Maxar

```{r, echo = FALSE}
maxar_pred_polys <- maxar_preds %>%
  map_dfr(~ pred_as_poly(.x)) %>%
  mutate(imagery = 'maxar')

maxar_pred_polys_ls <- maxar_preds %>%
  map(~ pred_as_poly(.x) %>%
        mutate(imagery = 'maxar'))
```

### Planet

```{r, echo = FALSE}
planet_pred_polys <- planet_preds %>%
  map_dfr(~ pred_as_poly(.x)) %>%
  mutate(imagery = 'planet')

planet_pred_polys_ls <- planet_preds %>%
  map(~ pred_as_poly(.x) %>%
        mutate(imagery = 'planet'))
```

### Sentinel

```{r, echo = FALSE}
sentinel_pred_polys <- sentinel_preds %>%
  map_dfr(~ pred_as_poly(.x)) %>%
  mutate(imagery = 'sentinel')

sentinel_pred_polys_ls <- sentinel_preds %>%
  map(~ pred_as_poly(.x) %>%
        mutate(imagery = 'sentinel'))
```


### Join Polygons into One SF Dataframe
```{r, echo = FALSE}
pred_polys <- maxar_pred_polys %>%
  rbind(planet_pred_polys) %>%
  rbind(sentinel_pred_polys)
```


## Convert Validation to Vector
### Maxar

```{r, echo = FALSE}
maxar_val_polys <- maxar_preds %>%
  map_dfr(~ val_as_poly(.x)) %>%
  mutate(imagery = 'maxar')

maxar_val_polys_ls <- maxar_preds %>%
  map(~ val_as_poly(.x))
```

### Planet

```{r, echo = FALSE}
planet_val_polys <- planet_preds %>%
  map_dfr(~ val_as_poly(.x)) %>%
  mutate(imagery = 'planet')

planet_val_polys_ls <- planet_preds %>%
  map(~ val_as_poly(.x))
```

### Sentinel

```{r, echo = FALSE}
sentinel_val_polys <- sentinel_preds %>%
  map_dfr(~ val_as_poly(.x)) %>%
  mutate(imagery = 'sentinel')

sentinel_val_polys_ls <- sentinel_preds %>%
  map(~ val_as_poly(.x))
```

### Join Polygons into One SF Dataframe

```{r, echo = FALSE}
val_polys <- maxar_val_polys %>%
  rbind(planet_val_polys) %>%
  rbind(sentinel_val_polys)
```


## Join Prediction and Validation Polygons
```{r, echo = FALSE}
polys <- pred_polys %>%
  rename(pred_geometry = geometry) %>%
  as_tibble() %>%
  full_join(val_polys %>%
              rename(val_geometry = geometry) %>%
              as_tibble(),
            by = c('id', 'imagery')) %>%
  st_as_sf(crs = st_crs(pred_polys))
```


## Interactive Map of Features

```{r, echo = FALSE}
pal_viridis <- colorFactor("viridis", pred_polys$imagery)

leaflet() %>%
  addProviderTiles('Esri.WorldImagery') %>%
  addPolygons(data = pred_polys %>%
                st_transform(crs = 4326), 
              color = ~ pal_viridis(imagery),
              fill = FALSE,
              weight = 2) %>%
  addLegend(data = pred_polys, 
            pal = pal_viridis, 
            values = ~ imagery) %>%
  addPolygons(data = val_polys %>%
                st_transform(crs = 4326), 
              color = 'black',
              fill = FALSE,
              weight = 2)
```


## IoU
### Calculate Intersection

```{r, echo = FALSE}
intersection <- st_intersection(pred_polys, val_polys)
intersection <- intersection %>%
  filter(id == id.1 & imagery == imagery.1) %>%
  select(id, imagery, int_geometry = geometry)
```

### Calculate Union

```{r, echo = FALSE}
union <- st_union(pred_polys, val_polys)
union <- union %>%
  filter(id == id.1 & imagery == imagery.1) %>%
  select(id, imagery, uni_geometry = geometry)
```

### Join Back to Polys

```{r, echo = FALSE}
polys <- polys %>%
  as_tibble() %>%
  full_join(intersection %>%
              as_tibble(),
            by = c('id', 'imagery')) %>%
  full_join(union %>%
              as_tibble(),
            by = c('id', 'imagery')) %>%
  st_as_sf(crs = 26901)
```

### Calculate IoU

```{r, echo = FALSE}
polys <- polys %>%
  mutate(iou = round(as.numeric(st_area(int_geometry)/st_area(uni_geometry)), 2))
```

```{r, echo = FALSE}
maxar_iou <- polys %>%
  as_tibble() %>%
  filter(imagery == 'maxar') %>%
  summarise(iou = mean(iou)) %>%
  as.numeric()

planet_iou <- polys %>%
  as_tibble() %>%
  filter(imagery == 'planet') %>%
  summarise(iou = mean(iou)) %>%
  as.numeric()

sentinel_iou <- polys %>%
  as_tibble() %>%
  filter(imagery == 'sentinel') %>%
  summarise(iou = mean(iou)) %>%
  as.numeric()
```
Maxar IoU: `r maxar_iou`

Planet IoU: `r planet_iou`

Sentinel-2 IoU: `r sentinel_iou`

## Mean Average Precision

```{r}
ap <- function(truth, iou, thresholds) {
  
  df <- tibble(ground_truth = truth,
               iou_score = iou)
  precision <- c()
  recall <- c()
  
  for (threshold in thresholds) {
    print(threshold)
    pred_class <- if_else(iou >= threshold,
                          'positive',
                          'negative')
    
    df <- df %>%
      mutate(class = case_when(iou_score >= threshold & ground_truth == 1 ~ 'true positive',
                               iou_score >= threshold & ground_truth == 0 ~ 'false positive',
                               iou_score < threshold & ground_truth == 1 ~ 'false negative',
                               iou_score < threshold & ground_truth == 0 ~ 'true negative'))
    print(df)

    # precision <- c(precision, length(class[class == 'positive'])/)
    # recall <- c(recall, )
    
  }
}

truth <- rep(1, 3)
iou <- c(0.33, 0.50, 0.62)
thresholds <- c(0.2, 0.5)

ap(truth, iou, thresholds)
```

## Performance by Feature Size
### Calculate Area

```{r, echo = FALSE}
polys <- polys %>%
  mutate(rts_area = round(as.numeric(st_area(val_geometry)), 2),
         rts_area_class = round(rts_area, -2))

poly_size_summary <- polys %>%
  group_by(imagery, rts_area_class) %>%
  summarise(iou_mean = mean(iou),
            iou_se = sd(iou)/sqrt(n()))
```

### Plot

Raw IoU Scores:

```{r, echo = FALSE}
ggplot(polys, aes(x = rts_area, y = iou, color = imagery)) +
  geom_point() +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs")) +
  scale_x_continuous(name = expression('RTS Area (m'^2*')')) +
  scale_y_continuous(name = 'IoU') +
  scale_color_manual(values = c('#FFCC00', '#0099AA', '#0000AA'),
                     labels = c('Maxar', 'Planet', 'Sentinel-2')) +
  theme_bw() +
  theme(legend.title = element_blank()) + 
  coord_cartesian(ylim = c(0, 1)) 
```

Binned IoU Scores:

```{r, echo = FALSE}
ggplot(poly_size_summary, 
       aes(x = rts_area_class, y = iou_mean, color = imagery)) +
  geom_point() +
  # geom_errorbar(aes(ymin = iou_mean - iou_se, ymax = iou_mean + iou_se)) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = "cs")) +
  scale_x_continuous(name = expression('RTS Area (m'^2*')')) +
  scale_y_continuous(name = 'IoU') +
  scale_color_manual(values = c('#FFCC00', '#0099AA', '#0000AA'),
                     labels = c('Maxar', 'Planet', 'Sentinel-2')) +
  scale_fill_manual(values = c('#FFCC00', '#0099AA', '#0000AA'),
                     labels = c('Maxar', 'Planet', 'Sentinel-2')) +
  theme_bw() +
  theme(legend.title = element_blank()) + 
  coord_cartesian(ylim = c(0, 1)) 
```