---
output:
  html_document: default
  pdf_document: default
---
# RTS Model V2 Performance Analysis

## TODO:

-   get authorization to work consistently
-   Figure out why there are multiple polygons for each imagery type and polygon.
-   Figure out why validation polygons won't convert to vector properly. The output looks like it is coming from the prediction layer not the validation layer.
-   Figure out which polygons the predictions were run for.

## Load Libraries

```{r, include = FALSE}
library(terra)
library(sf)
library(leaflet)
library(viridis)
library(googledrive)
library(jsonlite)
library(tidyverse)
```

## Prep Google Drive Authentication

```{r, include = FALSE}
drive_auth(email = 'hrodenhizer@woodwellclimate.org')
```

## Load Data

```{r, include = FALSE}
make_my_dir <- function(output_dir) {

  if (!dir.exists(output_dir)){
    dir.create(output_dir, recursive = TRUE)
  }
  
}
```

```{r, include = FALSE}
rast_from_googledrive <- function(name, id, drive_resource, directory) {
  current <- as_dribble(id)
  make_my_dir(directory)
  filepath = paste0(directory, name)
  print(filepath)
  try(dl <- drive_download(
    current,
    path = filepath,
    overwrite = FALSE))
  raster <- rast(filepath)
  names(raster) <- c('prediction', 'validation')
  return(raster)
}
```

```{r, include = FALSE}
json_from_googledrive <- function(name, id, drive_resource, directory) {
  current <- as_dribble(id)
  make_my_dir(directory)
  filepath = paste0(directory, name)
  try(dl <- drive_download(
    current,
    path = filepath,
    overwrite = FALSE),
    silent = TRUE)
  json <- fromJSON(txt = filepath)
  return(json)
}
```

### RTS Polygons

```{r, include = FALSE}

```

### Maxar GeoTiffs

#### 20220925-105508
Parameters:

```{r, echo = FALSE}
# json metadata
metadata <- drive_ls('https://drive.google.com/drive/u/0/folders/1jUsWsjRPGSROwsT8ENHdsRhxen0p0FlN',
                             pattern = 'json$')
maxar_metadata_1 <- metadata %>%
  pmap(
    \(name, id, drive_resource, directory) json_from_googledrive(name, id, drive_resource, './data/maxar/predictions-m20220925-105508/')
    )
maxar_metadata_1 %>%
  toJSON() %>%
  minify()
```

```{r, include = FALSE}
maxar_pred_files <- drive_ls('https://drive.google.com/drive/u/0/folders/1jUsWsjRPGSROwsT8ENHdsRhxen0p0FlN',
                             pattern = 'tif$') %>%
  arrange(name)

maxar_preds_1 <- maxar_pred_files %>%
  pmap(
    \(name, id, drive_resource, directory) rast_from_googledrive(name, id, drive_resource, './data/maxar/predictions-m20220925-105508/')
    )
```

#### 20220925-105508-fixed
Parameters:

```{r, echo = FALSE}
# json metadata
metadata <- drive_ls('https://drive.google.com/drive/u/0/folders/1HGSyxXaIoyGNY0nI6Rbqg7evPMZa_iAm',
                             pattern = 'json$')
maxar_metadata_2 <- metadata %>%
  pmap(
    \(name, id, drive_resource, directory) json_from_googledrive(name, id, drive_resource, './data/maxar/predictions-m20220925-105508-fixed/')
    )
maxar_metadata_2 %>%
  toJSON() %>%
  minify()
```

```{r, include = FALSE}
maxar_pred_files <- drive_ls('https://drive.google.com/drive/u/0/folders/1HGSyxXaIoyGNY0nI6Rbqg7evPMZa_iAm',
                             pattern = 'tif$') %>%
  arrange(name)

maxar_preds_2 <- maxar_pred_files %>%
  pmap(
    \(name, id, drive_resource, directory) rast_from_googledrive(name, id, drive_resource, './data/maxar/predictions-m20220925-105508-fixed/')
    )
```


#### 20230317-181045
Parameters:

```{r, echo = FALSE}
# json metadata
metadata <- drive_ls('https://drive.google.com/drive/u/0/folders/1QicQlzWuaMh-muI28FPz-TlwTybAcB8T',
                             pattern = 'json$')
maxar_metadata_3 <- metadata %>%
  pmap(
    \(name, id, drive_resource, directory) json_from_googledrive(name, id, drive_resource, './data/maxar/predictions-m20230317-181045/')
    )
maxar_metadata_3 %>%
  toJSON() %>%
  minify()
```

```{r, include = FALSE}
maxar_pred_files <- drive_ls('https://drive.google.com/drive/u/0/folders/1QicQlzWuaMh-muI28FPz-TlwTybAcB8T',
                             pattern = 'tif$') %>%
  arrange(name)

maxar_preds_3 <- maxar_pred_files %>%
  pmap(
    \(name, id, drive_resource, directory) rast_from_googledrive(name, id, drive_resource, './data/maxar/predictions-m20230317-181045/')
    )
```



#### 20230426-213214
Parameters:

```{r, echo = FALSE}
# json metadata
metadata <- drive_ls('https://drive.google.com/drive/u/0/folders/10btUO5v9iLRRM0WM5hstBXgtfYEfSYGZ',
                             pattern = 'json$')
maxar_metadata_4 <- metadata %>%
  pmap(
    \(name, id, drive_resource, directory) json_from_googledrive(name, id, drive_resource, './data/maxar/predictions-m20230426-213214/')
    )
maxar_metadata_4 %>%
  toJSON() %>%
  minify()
```

```{r, include = FALSE}
maxar_pred_files <- drive_ls('https://drive.google.com/drive/u/0/folders/10btUO5v9iLRRM0WM5hstBXgtfYEfSYGZ',
                             pattern = 'tif$') %>%
  arrange(name)

maxar_preds_4 <- maxar_pred_files %>%
  pmap(
    \(name, id, drive_resource, directory) rast_from_googledrive(name, id, drive_resource, './data/maxar/predictions-m20230426-213214/')
    )
```

### Planet GeoTiffs

#### 20230411-102851

Parameters:
```{r, echo = FALSE}
# json metadata
metadata <- drive_ls('https://drive.google.com/drive/u/0/folders/15vdbvwgMh5RCnEzJekWY0_sVD4s4-fec',
                             pattern = 'json$')
planet_metadata_1 <- metadata %>%
  pmap(
    \(name, id, drive_resource, directory) json_from_googledrive(name, id, drive_resource, './data/planet/predictions-m20230411-102851/')
    )
planet_metadata_1 %>%
  toJSON() %>%
  minify()
```

```{r, include = FALSE}
planet_pred_files <- drive_ls('https://drive.google.com/drive/u/0/folders/15vdbvwgMh5RCnEzJekWY0_sVD4s4-fec',
                             pattern = 'tif$') %>%
  arrange(name)

planet_preds_1 <- planet_pred_files %>%
  pmap(
    \(name, id, drive_resource, directory) rast_from_googledrive(name, id, drive_resource, './data/planet/predictions-m20230411-102851/')
    )
```

#### 20230411-102851-fixed

Parameters:
```{r, echo = FALSE}
# json metadata
metadata <- drive_ls('https://drive.google.com/drive/u/0/folders/1Y28fskc7woYjZgh14xP-SBs-bKuG_PW0',
                             pattern = 'json$')
planet_metadata_2 <- metadata %>%
  pmap(
    \(name, id, drive_resource, directory) json_from_googledrive(name, id, drive_resource, './data/planet/predictions-m20230411-102851-fixed/')
    )
planet_metadata_2 %>%
  toJSON() %>%
  minify()
```

```{r, include = FALSE}
planet_pred_files <- drive_ls('https://drive.google.com/drive/u/0/folders/1Y28fskc7woYjZgh14xP-SBs-bKuG_PW0',
                             pattern = 'tif$') %>%
  arrange(name)

planet_preds_2 <- planet_pred_files %>%
  pmap(
    \(name, id, drive_resource, directory) rast_from_googledrive(name, id, drive_resource, './data/planet/predictions-m20230411-102851-fixed/')
    )
```

### Sentinel GeoTiffs

#### 20220923-131534

Parameters:
```{r, echo = FALSE}
# json metadata
metadata <- drive_ls('https://drive.google.com/drive/u/0/folders/1HygGBu1WZatYv1ejU80nOynGkYQU0Rsg',
                             pattern = 'json$')
sentinel_metadata_1 <- metadata %>%
  pmap(
    \(name, id, drive_resource, directory) json_from_googledrive(name, id, drive_resource, './data/sentinel2/predictions-m20220923-131534/')
    )
sentinel_metadata_1 %>%
  toJSON() %>%
  minify()
```

```{r, include = FALSE}
sentinel_pred_files <- drive_ls('https://drive.google.com/drive/u/0/folders/1HygGBu1WZatYv1ejU80nOynGkYQU0Rsg',
                             pattern = 'tif$') %>%
  arrange(name)

sentinel_preds_1 <- sentinel_pred_files %>%
  pmap(
    \(name, id, drive_resource, directory) rast_from_googledrive(name, id, drive_resource, './data/sentinel2/predictions-m20220923-131534/')
    )
```

## Convert Predictions to Vector

```{r}
pred_as_poly <- function(prediction) {
  layer <- prediction[['prediction']]
  layer[layer >= 0.5] <- 1
  layer[layer < 0.5] <- NA
  return(
    st_transform(
      st_as_sf(as.polygons(layer, values = FALSE)), 
      crs = 4326
    ) %>%
      mutate(id = as.numeric(first(str_split(last(str_split(sources(prediction), 
                                                            '/')[[1]]), 
                                             '\\.')[[1]])))
  )
}
```

For now, use this to choose which version of the model output to use.
```{r}
maxar_preds <- maxar_preds_2
planet_preds <- planet_preds_2
sentinel_preds <- sentinel_preds_1
```

### Maxar

```{r}
maxar_pred_polys <- maxar_preds %>%
  map_dfr(~ pred_as_poly(.x)) %>%
  mutate(imagery = 'maxar')

maxar_pred_polys_ls <- maxar_preds %>%
  map(~ pred_as_poly(.x) %>%
        mutate(imagery = 'maxar'))
```

### Planet

```{r}
planet_pred_polys <- planet_preds %>%
  map_dfr(~ pred_as_poly(.x)) %>%
  mutate(imagery = 'planet')

planet_pred_polys_ls <- planet_preds %>%
  map(~ pred_as_poly(.x) %>%
        mutate(imagery = 'planet'))
```

### Sentinel

```{r}
sentinel_pred_polys <- sentinel_preds %>%
  map_dfr(~ pred_as_poly(.x)) %>%
  mutate(imagery = 'sentinel')

sentinel_pred_polys_ls <- sentinel_preds %>%
  map(~ pred_as_poly(.x) %>%
        mutate(imagery = 'sentinel'))
```


### Join Polygons into One SF Dataframe
```{r}
pred_polys <- maxar_pred_polys %>%
  rbind(planet_pred_polys) %>%
  rbind(sentinel_pred_polys)
```

## Convert Validation to Vector

```{r}
val_as_poly <- function(prediction) {
  layer <- prediction[['validation']]
  layer <- classify(layer, 
                    matrix(c(0, NA,
                             1, 1),
                           ncol = 2,
                           byrow = TRUE))
  return(
    st_transform(
      st_as_sf(as.polygons(layer, values = FALSE)), 
      crs = 4326
    ) %>%
      mutate(id = as.numeric(first(str_split(last(str_split(sources(prediction), 
                                                            '/')[[1]]), 
                                             '\\.')[[1]])))
  )
}
```

### Maxar

```{r}
maxar_val_polys <- maxar_preds %>%
  map_dfr(~ val_as_poly(.x)) %>%
  mutate(imagery = 'maxar')

maxar_val_polys_ls <- maxar_preds %>%
  map(~ val_as_poly(.x))
```

### Planet

```{r}
planet_val_polys <- planet_preds %>%
  map_dfr(~ val_as_poly(.x)) %>%
  mutate(imagery = 'planet')

planet_val_polys_ls <- planet_preds %>%
  map(~ val_as_poly(.x))
```

### Sentinel

```{r}
sentinel_val_polys <- sentinel_preds %>%
  map_dfr(~ val_as_poly(.x)) %>%
  mutate(imagery = 'sentinel')

sentinel_val_polys_ls <- sentinel_preds %>%
  map(~ val_as_poly(.x))
```

### Join Polygons into One SF Dataframe

```{r}
val_polys <- maxar_val_polys %>%
  rbind(planet_val_polys) %>%
  rbind(sentinel_val_polys)
```

## IoU

```{r}
custom_intersection <- function(pred, val) {
  
  val <- val %>%
    select(geometry)
  
  intersection <- pred %>%
    st_intersection(val)
  print(intersection)
  
  union <- pred %>%
  st_union(val)
  print(union)
  
  iou <- st_area(intersection)/st_area(union)
  print(iou)
  
  return(iou)
}
```

```{r}
intersection <- map2_dfr(maxar_pred_polys_ls, maxar_val_polys_ls,
                         ~ custom_intersection(.x, .y))

# pred <- maxar_pred_polys_ls[[1]]
# val <- maxar_val_polys_ls[[1]]
# intersection_area <- pred %>%
#   st_intersection(val) %>%
#   st_area()
# union_area <- pred %>%
#   st_union(val) %>%
#   st_area()
# 
# iou <- intersection_area/union_area
# iou
# 
# plot(pred)
# plot(val)

```

```{r}
maxar_preds[[1]]
```

## Plot

```{r}
pal_viridis <- colorFactor("viridis", pred_polys$imagery)

leaflet() %>%
  addProviderTiles('Esri.WorldImagery') %>%
  addPolygons(data = pred_polys, 
              color = ~ pal_viridis(imagery),
              fill = FALSE,
              weight = 2) %>%
  addLegend(data = pred_polys, 
            pal = pal_viridis, 
            values = ~ imagery) %>%
  addPolygons(data = val_polys, 
              color = 'black',
              fill = FALSE,
              weight = 2)
```
